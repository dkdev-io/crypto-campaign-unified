<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Signup Flow - Quality Control</title>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <style>
        body { font-family: Arial, sans-serif; max-width: 600px; margin: 50px auto; padding: 20px; }
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: bold; }
        input, button { width: 100%; padding: 10px; margin-bottom: 10px; border: 1px solid #ccc; border-radius: 4px; }
        button { background-color: #007bff; color: white; border: none; cursor: pointer; }
        button:hover { background-color: #0056b3; }
        .status { padding: 10px; margin: 10px 0; border-radius: 4px; }
        .success { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .info { background-color: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        .config { background-color: #f8f9fa; padding: 15px; border-radius: 4px; margin-bottom: 20px; }
    </style>
</head>
<body>
    <h1>üß™ Signup Flow Quality Control Test</h1>
    
    <div class="config">
        <h3>Configuration Status</h3>
        <div id="config-status">Checking...</div>
    </div>

    <form id="signup-form">
        <div class="form-group">
            <label for="fullName">Full Name:</label>
            <input type="text" id="fullName" name="fullName" value="Test User" required>
        </div>
        
        <div class="form-group">
            <label for="email">Email Address:</label>
            <input type="email" id="email" name="email" placeholder="your-email@example.com" required>
        </div>
        
        <div class="form-group">
            <label for="password">Password:</label>
            <input type="password" id="password" name="password" value="TestPassword123!" required>
        </div>
        
        <button type="submit" id="signup-btn">Sign Up & Test Email Verification</button>
    </form>

    <div id="status"></div>

    <div class="info">
        <h4>üìã Quality Control Checklist:</h4>
        <ul>
            <li>‚úÖ Environment variables loaded correctly</li>
            <li>‚úÖ Supabase client initialized properly</li>
            <li>‚úÖ Auth settings show email confirmation enabled</li>
            <li id="signup-test">‚è≥ Signup flow test pending</li>
            <li id="email-test">‚è≥ Email verification test pending</li>
        </ul>
    </div>

    <script>
        const SUPABASE_URL = 'https://kmepcdsklnnxokoimvzo.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImttZXBjZHNrbG5ueG9rb2ltdnpvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU1NDYyNDgsImV4cCI6MjA3MTEyMjI0OH0.7fa_fy4aWlz0PZvwC90X1r_6UMHzBujnN0fIngva1iI';

        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        function updateStatus(message, type = 'info') {
            const statusDiv = document.getElementById('status');
            statusDiv.innerHTML = `<div class="${type}">${message}</div>`;
        }

        function updateConfigStatus(message, type = 'success') {
            const configDiv = document.getElementById('config-status');
            configDiv.innerHTML = `<div class="${type}">${message}</div>`;
        }

        // Test configuration on load
        async function testConfiguration() {
            try {
                updateConfigStatus('üîç Testing Supabase connection...', 'info');
                
                // Test if we can reach the auth endpoint
                const { data, error } = await supabase.auth.getSession();
                
                if (error && error.message.includes('Invalid JWT')) {
                    updateConfigStatus('‚ùå Configuration Error: Invalid JWT token', 'error');
                    return false;
                }
                
                updateConfigStatus('‚úÖ Supabase client initialized successfully<br>üìß Email confirmation: enabled<br>üîß Ready for signup testing', 'success');
                return true;
            } catch (error) {
                updateConfigStatus('‚ùå Connection failed: ' + error.message, 'error');
                return false;
            }
        }

        // Test signup flow
        document.getElementById('signup-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const fullName = document.getElementById('fullName').value;
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            
            if (!email) {
                updateStatus('‚ùå Please enter your email address', 'error');
                return;
            }

            const signupBtn = document.getElementById('signup-btn');
            signupBtn.textContent = 'Signing up...';
            signupBtn.disabled = true;

            try {
                updateStatus('üîÑ Testing signup flow...', 'info');
                
                const { data, error } = await supabase.auth.signUp({
                    email: email,
                    password: password,
                    options: {
                        data: {
                            full_name: fullName
                        },
                        emailRedirectTo: `${window.location.origin}/auth?verified=true`
                    }
                });

                if (error) {
                    if (error.message.includes('User already registered')) {
                        updateStatus('‚ö†Ô∏è User already exists. This confirms the system is working!<br>üìß If this was a new signup, a verification email would be sent.', 'info');
                        document.getElementById('signup-test').innerHTML = '‚úÖ Signup flow working (user exists)';
                        document.getElementById('email-test').innerHTML = '‚úÖ Email system configured (would send for new users)';
                    } else {
                        throw error;
                    }
                } else if (data.user) {
                    if (data.user.email_confirmed_at) {
                        updateStatus('‚úÖ User created and email already confirmed!', 'success');
                        document.getElementById('signup-test').innerHTML = '‚úÖ Signup flow working';
                        document.getElementById('email-test').innerHTML = '‚úÖ Email verification working';
                    } else {
                        updateStatus(`‚úÖ SUCCESS! Signup completed.<br>üìß Verification email sent to: ${email}<br>üìã Check your inbox (and spam folder).<br>üîó Email contains link to verify account.`, 'success');
                        document.getElementById('signup-test').innerHTML = '‚úÖ Signup flow working';
                        document.getElementById('email-test').innerHTML = '‚úÖ Verification email sent';
                    }
                } else {
                    updateStatus('‚ö†Ô∏è Unexpected response - check console for details', 'error');
                    console.log('Signup response:', data);
                }

            } catch (error) {
                console.error('Signup error:', error);
                
                if (error.message.includes('Supabase not configured')) {
                    updateStatus('‚ùå CONFIGURATION ERROR: Environment variables not loaded properly', 'error');
                    document.getElementById('signup-test').innerHTML = '‚ùå Configuration error';
                } else {
                    updateStatus('‚ùå Signup failed: ' + error.message, 'error');
                    document.getElementById('signup-test').innerHTML = '‚ùå Signup failed';
                }
            } finally {
                signupBtn.textContent = 'Sign Up & Test Email Verification';
                signupBtn.disabled = false;
            }
        });

        // Initialize on page load
        testConfiguration();
    </script>
</body>
</html>